name: Build Worker

# Template source: https://github.com/dockersamples/.github/blob/main/templates/call-docker-build.yaml

# Define when this workflow should be triggered
on:
  # Trigger on pushes to the 'main' branch when 'worker/' directory or workflow file changes
  push:
    branches:
      - 'main'
    paths:
      - 'worker/**'
      - '.github/workflows/call-docker-build-worker.yaml'
  # Trigger on pull requests to the 'main' branch when 'worker/' directory or workflow file changes
  pull_request:
    branches:
      - 'main'
    paths:
      - 'worker/**'
      - '.github/workflows/call-docker-build-worker.yaml'

jobs:
  call-docker-build:

    name: Worker Call Docker Build

    # Use the 'actions/checkout@v2' action to check out the repository
    uses: actions/checkout@v2

    # Define permissions for the workflow
    permissions:
      contents: read
      packages: write # needed to push docker image to ghcr.io
      pull-requests: write # needed to create and update comments in PRs
    
    secrets:

      # Only needed if with:dockerhub-enable is true below
      dockerhub-username: ${{ secrets.DOCKER_USERNAME }}

      # Only needed if with:dockerhub-enable is true below
      dockerhub-token: ${{ secrets.DOCKER_PASSWORD }}

    with:
      
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### Tell Docker where to push.
      ### NOTE: If Docker Hub is set to true, you must set secrets above and also add account/repo/tags below
      dockerhub-enable: true
      ghcr-enable: true

      ### REQUIRED 
      ### A list of the account/repo names for docker build. List should match what's enabled above
      ### Defaults to:
      image-names: |
        ghcr.io/dockersamples/example-voting-app-worker
        dockersamples/examplevotingapp_worker
      
      ### REQUIRED set rules for tagging images, based on special action syntax:
      ### https://github.com/docker/metadata-action#tags-input
      ### Defaults to:
      tag-rules: |
        type=raw,value=latest,enable=${{ endsWith(github.ref, github.event.repository.default_branch) }}
        type=ref,event=pr
      
      ### Path to where Docker should copy files into the image
      ### Defaults to the root of the repository (.)
      context: worker
      
      ### Dockerfile alternate name. Default is Dockerfile (relative to the context path)
      # file: Containerfile

      ### Build stage to target, defaults to empty, which builds to the last stage in Dockerfile
      # target:
      
      ### Platforms to build for, defaults to linux/amd64
      ### Other options: linux/amd64, linux/arm64, linux/arm/v7
      # FIXME: Worker arm/v7 support doesn't build in .net core 3.1 with QEMU
      # A fix would likely run the .net build on amd64 but with a target of arm/v7
      platforms: linux/amd64, linux/arm64, linux/arm/v7
      
      ### Create a PR comment with image tags and labels
      ### Defaults to false
      # comment-enable: false
